<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DayTracker - Expenses</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container mt-5">

    <h1 class="mb-4">My Expenses</h1>

    <!-- Flash Messages - Auto-hide after 3 seconds -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for msg in messages %}
          <div class="alert alert-warning alert-dismissible fade show" role="alert" id="flash-{{ loop.index }}">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Set Monthly Budget Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Set Monthly Budget</h2>
        </div>
        <div class="card-body">
            <form action="{{ url_for('set_budget') }}" method="post" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Monthly Budget ($)</label>
                    <input type="number" name="budget" class="form-control" step="0.01" min="0" 
                           value="{{ budget }}" placeholder="1000" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Month</label>
                    <input type="month" name="month" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Year</label>
                    <input type="number" name="year" class="form-control" min="2020" max="2030" required>
                </div>
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-outline-primary h-100 mt-4">Update Budget</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Expense Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Add New Expense</h2>
        </div>
        <div class="card-body">
            <form action="{{ url_for('add_expense') }}" method="post" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="description" class="form-control" placeholder="Expense Description" required>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" min="0" name="amount" class="form-control" placeholder="Amount" required>
                </div>
                <div class="col-md-3">
                    <input type="date" name="date" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Summary -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="alert alert-info">
                <h5>Monthly Budget</h5>
                ${{ '%.2f'|format(budget) }}
                {% if budget == 0 %}
                    <small class="text-warning">Set your budget first!</small>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="alert alert-warning">
                <h5>Total Spent</h5>
                ${{ '%.2f'|format(total_spent) }}
            </div>
        </div>
        <div class="col-md-4">
            {% if budget > 0 %}
                <div class="alert {{ 'alert-success' if remaining_budget >= 0 else 'alert-danger' }}">
                    <h5>Remaining Budget</h5>
                    ${{ '%.2f'|format(remaining_budget) }}
                </div>
            {% else %}
                <div class="alert alert-secondary">
                    <h5>Remaining Budget</h5>
                    <small>Set budget to see remaining</small>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Expenses List -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">This Month's Expenses</h2>
        </div>
        <div class="card-body">
            {% if expenses %}
              <ul class="list-group list-group-flush">
                {% for expense in expenses %}
                  <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <div class="flex-grow-1">
                      <div class="fw-bold">{{ expense.date.strftime('%Y-%m-%d') }}</div>
                      <div>{{ expense.description }}: ${{ '%.2f'|format(expense.amount) }}</div>
                    </div>
                    <form class="m-0" action="{{ url_for('delete_expense', id=expense.id) }}" method="post">
                        <button type="submit" class="btn btn-danger btn-sm"
                                onclick="return confirm('Delete this expense?')">
                            Delete
                        </button>
                    </form>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">No expenses recorded this month.</p>
            {% endif %}
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
                {% if pagination.has_prev %}
                    <a href="{{ url_for('home', page=pagination.prev_num) }}" class="btn btn-sm btn-outline-secondary">Previous</a>
                {% endif %}
                {% if pagination.has_next %}
                    <a href="{{ url_for('home', page=pagination.next_num) }}" class="btn btn-sm btn-outline-secondary ms-2">Next</a>
                {% endif %}
            </div>
            <span class="text-muted">Page {{ pagination.page }} of {{ pagination.pages }}</span>
        </div>
    </div>

    <!-- Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Spending Trends This Month</h2>
        </div>
        <div class="card-body p-4">
            <canvas id="spendingChart" height="120"></canvas>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row">
        <div class="col-md-8">
            <a href="{{ url_for('experiences') }}" class="btn btn-secondary me-2">My Experiences</a>
            <a href="{{ url_for('profile') }}" class="btn btn-outline-primary me-2">Profile</a>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Log out</a>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Auto-hide flash messages (3 seconds) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const flashAlerts = document.querySelectorAll('[id^="flash-"]');
    flashAlerts.forEach(function(alert) {
        setTimeout(function() {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 3000);
    });
});
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('spendingChart').getContext('2d');
const chartLabels = {{ chart_labels | tojson | safe }};
const chartData = {{ chart_data | tojson | safe }};

new Chart(ctx, {
  type: 'line',
  data: {
    labels: chartLabels,
    datasets: [{
      label: 'Daily Spending',
      backgroundColor: 'rgba(54, 162, 235, 0.4)',
      borderColor: 'rgba(54, 162, 235, 1)',
      fill: true,
      data: chartData,
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'Date' } },
      y: { 
        title: { display: true, text: 'Amount ($)' },
        beginAtZero: true
      }
    }
  }
});
</script>

</body>
</html>
