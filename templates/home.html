{% extends "base.html" %}
{% block title %}Expenses - DayTracker{% endblock %}
{% set show_navbar = False %}

{% block content %}
<!-- üî• CUSTOM COMPACT NAVBAR (exactly like your screenshot) -->
<nav class="navbar navbar-expand navbar-light bg-light border-bottom shadow-sm mb-4">
    <div class="container-fluid">
        <div class="navbar-brand fw-bold fs-5 text-primary">
            <i class="bi bi-calendar3 me-2"></i>DayTracker
        </div>
        <div class="navbar-nav ms-auto gap-2">
            <a href="{{ url_for('set_budget') }}" class="btn btn-outline-secondary btn-sm px-3">
                <i class="bi bi-wallet2 me-1"></i>Set Budget
            </a>
            <a href="{{ url_for('profile') }}" class="btn btn-outline-primary btn-sm px-3">
                <i class="bi bi-person me-1"></i>Profile
            </a>
            <a href="{{ url_for('experiences') }}" class="btn btn-outline-info btn-sm px-3">
                <i class="bi bi-journal-text me-1"></i>Experiences
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm px-3">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <!-- Flash Messages (uses base.html styling) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'message' else category }} 
                       alert-dismissible fade show mb-4" role="alert" id="flash-{{ loop.index }}">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- üî• SIMPLIFIED Budget Form (NO year/month fields) -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="h5 mb-0"><i class="bi bi-wallet2 me-2"></i>Set Monthly Budget</h3>
        </div>
        <div class="card-body">
            <form action="{{ url_for('set_budget') }}" method="POST" class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label class="form-label fw-semibold fs-5">Monthly Budget</label>
                    <div class="input-group">
                        <span class="input-group-text">‚Çπ</span>
                        <input type="number" name="budget" class="form-control form-control-lg" 
                               step="0.01" min="0" value="{{ budget }}" placeholder="Enter amount" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100 py-3 fs-5">
                        <i class="bi bi-check-circle me-2"></i>Update Budget
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Expense Form -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h3 class="h5 mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Expense</h3>
        </div>
        <div class="card-body">
            <form action="{{ url_for('add_expense') }}" method="POST" class="row g-3">
                <div class="col-md-5">
                    <input type="text" name="description" class="form-control form-control-lg" 
                           placeholder="Expense description (Groceries, Transport, etc.)" required>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text">‚Çπ</span>
                        <input type="number" name="amount" class="form-control form-control-lg" 
                               step="0.01" min="0" placeholder="0.00" required>
                    </div>
                </div>
                <div class="col-md-2">
                    <input type="date" name="date" class="form-control form-control-lg" 
                           value="{{ now.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 py-3 fs-5">Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card h-100 text-center bg-primary text-white shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-piggy-bank"></i> Monthly Budget</h5>
                    <h2 class="display-6 fw-bold">‚Çπ{{ "%.2f"|format(budget) }}</h2>
                    {% if budget == 0 %}
                        <p class="card-text"><small>Set your budget first!</small></p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 text-center bg-warning text-dark shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-cash-stack"></i> Total Spent</h5>
                    <h2 class="display-6 fw-bold">‚Çπ{{ "%.2f"|format(total_spent) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 text-center {{ 'bg-success text-white' if remaining_budget > 0 else 'bg-danger text-white' }} shadow">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-graph-up"></i> Remaining</h5>
                    <h2 class="display-6 fw-bold">‚Çπ{{ "%.2f"|format(remaining_budget) }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Table -->
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h3 class="h5 mb-0"><i class="bi bi-list-ul me-2"></i>This Month's Expenses ({{ pagination.items|length }} items)</h3>
        </div>
        <div class="card-body p-0">
            {% if expenses %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.date.strftime('%d %b, %Y') }}</td>
                                <td>{{ expense.description }}</td>
                                <td class="text-end fw-bold text-primary">‚Çπ{{ "%.2f"|format(expense.amount) }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('delete_expense', id=expense.id) }}" 
                                          class="d-inline" onsubmit="return confirm('Delete this expense?')">
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-wallet display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">No expenses yet</h4>
                    <p class="text-muted">Add your first expense above!</p>
                </div>
            {% endif %}
        </div>
        {% if pagination.pages > 1 %}
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if pagination.has_prev %}
                        <a href="?page={{ pagination.prev_num }}" class="btn btn-sm btn-outline-secondary">‚Üê Previous</a>
                    {% endif %}
                    {% if pagination.has_next %}
                        <a href="?page={{ pagination.next_num }}" class="btn btn-sm btn-outline-secondary ms-2">Next ‚Üí</a>
                    {% endif %}
                </div>
                <span class="text-muted">Page {{ pagination.page }} of {{ pagination.pages }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Spending Chart -->
    <div class="card mt-4 shadow">
        <div class="card-header bg-secondary text-white">
            <h3 class="h5 mb-0"><i class="bi bi-graph-up me-2"></i>Spending Trends</h3>
        </div>
        <div class="card-body p-0">
            <canvas id="spendingChart" class="w-100" style="height: 400px;"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('spendingChart').getContext('2d');
const chartLabels = {{ chart_labels | tojson | safe }};
const chartData = {{ chart_data | tojson | safe }};

new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartLabels,
        datasets: [{
            label: 'Daily Spending (‚Çπ)',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderColor: 'rgba(40, 167, 69, 1)',
            fill: true,
            data: chartData,
            tension: 0.4,
            pointBackgroundColor: 'rgba(40, 167, 69, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(40, 167, 69, 1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { 
                title: { display: true, text: 'Amount (‚Çπ)' },
                beginAtZero: true
            }
        }
    }
});
</script>

{% endblock %}
